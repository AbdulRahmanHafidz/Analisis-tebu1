{% load static %}
<!DOCTYPE html>
<html>
<head>
  <title>Dashboard Analisa Tebu</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    /* Gaya Modal */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .modal-header {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .modal-footer {
      text-align: right;
      margin-top: 10px;
    }
    .btn {
      padding: 5px 10px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .btn-warning { background: orange; color: white; }
    .btn-danger { background: red; color: white; }
    .btn-secondary { background: gray; color: white; }
    .btn-primary { background: blue; color: white; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .nav-hover {
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .nav-hover:hover {
      background-color: #003300;
      color: #aaffaa !important;
      border-radius: 4px;
    }
  </style>
</head>
<body>
>
  <div class="d-flex">
    <nav class="flex-column p-3" style="width: 250px; background-color: #004d00; color: white; position: sticky; top: 0; height: 100vh;">
      <h3 class="mb-4">Menu</h3>
      <ul class="nav nav-pills flex-column">
        <li class="nav-item mb-2">
          <a class="nav-link text-white nav-hover" href="{% url 'dashboard' %}">Dashboard</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-white nav-hover" href="{% url 'tambah_analisa' %}">Tambah Analisa</a>
        </li>
        <li class="nav-item mt-auto">
          <a class="nav-link text-white nav-hover" href="{% url 'logout' %}">Logout</a>
        </li>
      </ul>
    </nav>

    <main class="container py-4" style="flex-grow: 1;">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Analisa Nira Tebu</h1>
      </div>

      <div class="d-flex flex-wrap align-items-center mb-3" style="gap: 8px;">
      <button class="btn btn-success" onclick="openTambahModal()">+ Tambah</button>
<!-- Modal Tambah Analisa -->
<div id="tambahModal" class="modal">
  <div class="modal-content">
    <form method="post" action="{% url 'tambah_analisa' %}">
      {% csrf_token %}
      <div class="modal-header">Tambah Analisa Nira Tebu</div>
      <div class="modal-body">
        <label>Brix:</label>
        <input type="number" step="0.01" name="brix" class="form-control" required><br>
        <label>Pol:</label>
        <input type="number" step="0.01" name="pol" class="form-control" required><br>
        <label>Suhu (Â°C):</label>
        <input type="number" step="0.01" name="suhu" class="form-control" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeTambahModal()">Batal</button>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </div>
    </form>
  </div>
</div>
  <script>
    function openTambahModal() {
      document.getElementById("tambahModal").style.display = "block";
    }
    function closeTambahModal() {
      document.getElementById("tambahModal").style.display = "none";
    }
    // Tutup modal kalau klik di luar box
    window.onclick = function(event) {
      if (event.target == document.getElementById("tambahModal")) {
        closeTambahModal();
      }
      if (event.target == document.getElementById("editModal")) {
        closeModal();
      }
    }
  </script>
    <a href="{% url 'export_analisa_tebu_excel' %}?{{ request.GET.urlencode }}" class="btn btn-outline-success">Download Excel</a>
    <form method="get" class="d-flex align-items-center" style="gap: 8px;">
      <label for="tanggal" class="form-label mb-0">Tanggal:</label>
      <input type="date" id="tanggal" name="tanggal" class="form-control" value="{% if 'tanggal' in request.GET %}{{ request.GET.tanggal }}{% else %}{{ current_date }}{% endif %}">
    <label for="shift" class="form-label mb-0">Shift:</label>
    <select id="shift" name="shift" class="form-control">
      <option value="">Pilih Shift</option>
      <option value="pagi" {% if request.GET.shift == 'pagi' %}selected{% endif %}>Shift Pagi</option>
      <option value="sore" {% if request.GET.shift == 'sore' %}selected{% endif %}>Shift Sore</option>
      <option value="malam" {% if request.GET.shift == 'malam' %}selected{% endif %}>Shift Malam</option>
    </select>
      <label for="search_no" class="form-label mb-0">Cari No:</label>
      <input type="number" id="search_no" name="search_no" class="form-control" placeholder="Cari No" value="{% if 'search_no' in request.GET %}{{ request.GET.search_no }}{% endif %}">
      <button type="submit" class="btn btn-primary">Tampilkan</button>
      {% if 'tanggal' in request.GET or 'shift' in request.GET or 'search_no' in request.GET %}
        <a href="?" class="btn btn-secondary">Reset</a>
      {% endif %}
    </form>
  </div>

  <div class="row mt-5">
    <div class="col-md-12">
      <table class="table table-bordered">
        <thead class="table-primary">
          <tr>
            <th>NO</th>
            <th>Tanggal</th>
            <th>Brix</th>
            <th>Suhu (Â°C)</th>
            <th>Pol</th>
            <th>Persen Brix</th>
            <th>Persen Pol</th>
            <th>HK</th>
            <th>NN</th>
            <th>Rendemen (%)</th>
            <th>PH</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          <!-- ðŸ”¹ Tambah baris rata-rata -->
          {% for d in data %}
          <tr>
            <td>{{ data.start_index|add:forloop.counter0 }}</td>
            <td>{{ d.tanggal }}</td>
          <td>{{ d.brix }}</td>
            <td>{{ d.suhu }}</td>
            <td>{{ d.pol }}</td>
            <td>{{ d.brix_koreksi }}</td>
            <td>{{ avg_pol }}</td>
            <td>{{ d.hk }}</td>
            <td>{{ d.nn }}</td>
            <td>{{ d.rendemen }}</td>
            <td>
              <form method="post" action="{% url 'update_ph' d.id %}" style="display: inline;">
                {% csrf_token %}
                <input type="number" step="0.01" name="ph" value="{{ d.ph }}" style="width: 80px;" required>
                <button type="submit" class="btn btn-primary btn-sm">Update</button>
              </form>
            </td>
    <td>
      <!-- Tombol Edit -->
          <button class="btn btn-warning" onclick="openModal('{{ d.id }}', '{{ d.brix }}', '{{ d.pol }}', '{{ d.suhu }}')">Edit</button>

          <!-- Tombol Hapus -->
          <form id="hapus-form-{{ d.id }}" action="{% url 'hapus_analisa' d.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="button" class="btn btn-danger"
              onclick="if(confirm('Yakin mau hapus data ini?')) { document.getElementById('hapus-form-{{ d.id }}').submit(); }">
              Hapus
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>

    {% if data.has_other_pages %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if data.has_previous %}
          <li class="page-item"><a class="page-link" href="?page={{ data.previous_page_number }}&{{ query_params.urlencode }}">Previous</a></li>
        {% endif %}

        {% for num in data.paginator.page_range %}
          {% if data.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
          {% elif num > data.number|add:'-2' and num < data.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}&{{ query_params.urlencode }}">{{ num }}</a></li>
          {% endif %}
        {% endfor %}

        {% if data.has_next %}
          <li class="page-item"><a class="page-link" href="?page={{ data.next_page_number }}&{{ query_params.urlencode }}">Next</a></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

    </div>

  </div>

<!-- Modal Edit -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <form method="post" id="editForm">
      {% csrf_token %}
      <div class="modal-header">Edit Analisa</div>
      <div class="modal-body">
        <input type="hidden" name="id" id="editId">
        <label>Brix:</label>
        <input type="number" step="0.01" name="brix" id="editBrix" required><br><br>
        <label>Pol:</label>
        <input type="number" step="0.01" name="pol" id="editPol" required><br><br>
        <label>Suhu (Â°C):</label>
        <input type="number" step="0.01" name="suhu" id="editSuhu" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Batal</button>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </div>
    </form>
  </div>
</div>
    <div class="col-md-9">
      <div class="row">
        <div class="col-12">
          <canvas id="chartMain" height="100"></canvas>
        </div>
        <div class="col-12">
          <canvas id="chartSuhuBrix" height="50"></canvas>
        </div>
      </div>
    </div>
  <script>
    const labels = [{% for d in data %}"{{ d.tanggal|date:'Y-m-d H:i' }}",{% endfor %}];
    const brix = [{% for d in data %}{{ d.brix }},{% endfor %}];
    const pol = [{% for d in data %}{{ d.pol }},{% endfor %}];
    const hk = [{% for d in data %}{{ d.hk }},{% endfor %}];
    const suhu = [{% for d in data %}{{ d.suhu }},{% endfor %}];
    const brixKoreksi = [{% for d in data %}{{ d.brix_koreksi }},{% endfor %}];

    // Grafik utama (Brix, Pol, HK)
    new Chart(document.getElementById('chartMain'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {label: 'Brix (%)', data: brix, borderColor: 'blue', fill: false},
          {label: 'Pol (%)', data: pol, borderColor: 'green', fill: false},
          {label: 'HK (%)', data: hk, borderColor: 'red', fill: false}
        ]
      }
    });

    // Grafik suhu vs brix koreksi
    new Chart(document.getElementById('chartSuhuBrix'), {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Suhu vs Brix Koreksi',
          data: [
            {% for d in data %}
              { x: {{ d.suhu }}, y: {{ d.brix_koreksi }} },
            {% endfor %}
          ],
          borderColor: 'orange',
          backgroundColor: 'orange'
        }]
      },
      options: {
        scales: {
          x: { title: { display: true, text: 'Suhu (Â°C)' }},
          y: { title: { display: true, text: 'Brix Koreksi (%)' }}
        }
      }
    });

    function openModal(id, brix, pol, suhu) {
  document.getElementById("editId").value = id;
  document.getElementById("editBrix").value = brix;
  document.getElementById("editPol").value = pol;
  document.getElementById("editSuhu").value = suhu;

  // ubah action form sesuai id
  document.getElementById("editForm").action = "/edit/" + id + "/";

  document.getElementById("editModal").style.display = "block";
}

function closeModal() {
  document.getElementById("editModal").style.display = "none";
}

// Tutup modal kalau klik di luar box
window.onclick = function(event) {
  if (event.target == document.getElementById("editModal")) {
    closeModal();
  }
}
  </script>

</body>
</html>
